{% extends 'base.html' %}

{% load i18n static %}

{% block extrascripts %}
  <script src="{% static 'third_party/gitgraph/gitgraph.min.js' %}"></script>
  <script>
    $(document).ready(function(){
      let myTemplateConfig = {
        commit: {
          shouldDisplayTooltipsInCompactMode: true,
          tooltipHTMLFormatter: function ( commit ) {
            return commit.message;
          }
        }
      };
      let root = location.protocol + '//' + location.host;

      let myTemplate = new GitGraph.Template( myTemplateConfig );

      let gitgraph = new GitGraph({
        template: myTemplate,
        orientation: 'horizontal-reverse',
      });

      gitgraph.canvas.addEventListener( "commit:mouseover", function ( event ) {
        this.style.cursor = "pointer";
      } );

      gitgraph.canvas.addEventListener("commit:mouseout", function (event) {
        this.style.cursor = "auto";
      });

      let tree = {{ tree }};

      if (tree) {
        document.getElementById('gitGraph').removeAttribute('hidden');
      }

      let branchesDict = {};

      function displayTree(commit_el, parent_branch_id) {
        if (!commit_el) return;

        let branch_id = commit_el['branch_id'];
        let commit_id = commit_el['commit_id'];

        if (parent_branch_id){
          branchesDict[parent_branch_id].checkout();
        }

        if (!branchesDict[branch_id]){
          branchesDict[branch_id] = gitgraph.branch(branch_id);
        } else {
          branchesDict[branch_id].checkout();
        }

        let commitConfig = {
            message: commit_el['title'] + ' (branch ' + branch_id + ', commit ' + commit_id + ', msg: ' + commit_el['commit_message'] + ')',
            onClick: function(commit) {
              window.location = root + commit_el['absolute_url'];
            },
          };

        if (branch_id == {{ branch_id }} && commit_id == {{ commit_id }}) {
          commitConfig['dotColor'] = "white";
          commitConfig['dotSize'] = 2;
          commitConfig['dotStrokeWidth'] = 2;
        }

        gitgraph.commit(commitConfig);

        let children = commit_el['children'];
        children.sort((a, b) => a['branch_id'] < b['branch_id']);
        console.dir(children);

        for (child of children){
          displayTree(child, branch_id);
        }
      }

      displayTree(tree);

      ///

      function onUpdate(event) {
       event.preventDefault();
       let form = document.getElementById("commit-form-id");
       form.setAttribute('action', '?update_commit=true');
       form.submit();
      }

      let updateBtn = document.getElementById("update-btn-id");
      updateBtn.addEventListener("click", onUpdate);
    });
  </script>
{% endblock %}

{% block extrastyles %}
  <link rel="stylesheet" type="text/css" href="{% static 'third_party/gitgraph/gitgraph.css' %}" />
{% endblock %}

{% block content %}
  <div class="row" style="padding-top: 5px">
    <canvas id="gitGraph" hidden></canvas>
  </div>

  {% if compos_title_form %}
    <form method="post" action="{% url 'literary-compos-update' compos_id branch_id commit_id %}">
    {% csrf_token %}
      <div class="row" style="padding-top: 15px">
        <div class="column small-10">
          {{ compos_title_form.title }}
        </div>
        <div class="column small-2">
          <button class="button float-right" id="commit-btn-id" name="commit-btn" type="submit">Update title</button>
        </div>
      </div>
    </form>
  {% endif %}

  <form method="post" id="commit-form-id">
    <div class="row">
      <div class="column small-12">
        {% csrf_token %}
        <div>
          {{ form.media }}
          {{ form.title }}
          {{ form.content }}
        </div>
      </div>
    </div>

    {% if commit_id %}
      <div class="row" style="padding-top: 15px">
        <div class="column small-offset-4 small-6">
          {{ form.commit_message }}
        </div>
        <div class="column small-1">
          <button class="button float-right" id="update-btn-id" name="update-btn" type="submit">Update</button>
        </div>
        <div class="column small-1">
          <button class="button float-right" id="commit-btn-id" name="commit-btn" type="submit">Commit</button>
        </div>
      </div>
    {% else %}
      <div class="row" style="padding-top: 15px">
        <div class="column small-offset-5 small-6">
          {{ form.commit_message }}
        </div>
        <div class="column small-1">
          <button class="button float-right" id="commit-btn-id" name="commit-btn" type="submit">Commit</button>
        </div>
      </div>
    {% endif %}

  </form>
{% endblock %}